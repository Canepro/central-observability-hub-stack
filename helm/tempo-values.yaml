# Tempo Helm Chart Values
# Deployment Mode: Monolithic

persistence:
  enabled: false

tempo:
  retention: 168h

  # Inject S3 credentials for Tempo (AWS SDK expects AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY)
  extraEnvFrom:
    - secretRef:
        name: loki-s3-credentials

  storage:
    trace:
      backend: s3
      s3:
        bucket: tempo-data
        endpoint: iducrocaj9h2.compat.objectstorage.us-ashburn-1.oraclecloud.com
        region: us-ashburn-1
        # IMPORTANT: do not embed credentials in config; let AWS SDK pick them up from env
        insecure: false
        forcepathstyle: true

      wal:
        path: /tmp/tempo/wal
      local:
        path: /tmp/tempo/traces

  receivers:
    otlp:
      protocols:
        http:
          endpoint: 0.0.0.0:4318
        grpc:
          endpoint: 0.0.0.0:4317
    jaeger:
      protocols:
        thrift_http:
          endpoint: 0.0.0.0:14268
        grpc:
          endpoint: 0.0.0.0:14250
    zipkin:
      endpoint: 0.0.0.0:9411

  compactor:
    compaction:
      block_retention: 168h

  # Generate RED/service graph metrics from traces and remote-write to Prometheus.
  metrics_generator:
    registry:
      external_labels:
        cluster: oke-hub
    storage:
      path: /tmp/tempo/generator/wal
      remote_write:
        - url: http://prometheus-server.monitoring.svc.cluster.local:80/api/v1/write
          send_exemplars: true

  overrides:
    defaults:
      metrics_generator:
        processors:
          - service-graphs
          - span-metrics
    per_tenant_override_config: /conf/overrides.yaml

securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 2000

service:
  type: ClusterIP
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "3200"
    prometheus.io/path: /metrics
  ports:
    - name: tempo-prom-metrics
      port: 3200
      protocol: TCP
      targetPort: 3200
    - name: otlp-grpc
      port: 4317
      protocol: TCP
      targetPort: 4317
    - name: otlp-http
      port: 4318
      protocol: TCP
      targetPort: 4318
    - name: jaeger-thrift-http
      port: 14268
      protocol: TCP
      targetPort: 14268
    - name: jaeger-grpc
      port: 14250
      protocol: TCP
      targetPort: 14250
    - name: zipkin
      port: 9411
      protocol: TCP
      targetPort: 9411

resources:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    cpu: 1
    memory: 1.5Gi
