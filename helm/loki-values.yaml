# Loki Helm Chart Values
# Chart: grafana/loki
# Deployment Mode: Single Binary (monolithic) with S3 Backend (OCI Object Storage)
deploymentMode: SingleBinary

# Use env vars from an existing Secret (secret contains AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY)
loki:
  extraEnvFrom:
    - secretRef:
        name: loki-s3-credentials

  # Single-tenant mode (handled by ingress auth in this stack)
  auth_enabled: false

  # IMPORTANT: replication_factor=1 => we can use in-memory ring and avoid memberlist/DNS entirely
  commonConfig:
    replication_factor: 1
    ring:
      kvstore:
        store: inmemory

  # Expand ${ENV_VAR} in the rendered config
  extraArgs:
    - -config.expand-env=true

  # S3 (OCI) storage configuration (chart-native keys)
  storage:
    type: s3
    bucketNames:
      chunks: loki-data
      ruler: loki-data
      admin: loki-data
    s3:
      # OCI S3-compatible endpoint (include https:// for signing parity)
      endpoint: https://iducrocaj9h2.compat.objectstorage.us-ashburn-1.oraclecloud.com
      region: us-ashburn-1
      accessKeyId: ${AWS_ACCESS_KEY_ID}
      secretAccessKey: ${AWS_SECRET_ACCESS_KEY}
      s3ForcePathStyle: true
      insecure: false

  # Schema Config
  schemaConfig:
    configs:
      - from: 2020-01-01
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h

  # Limits configuration
  limits_config:
    retention_period: 168h
    reject_old_samples: true
    reject_old_samples_max_age: 168h
    volume_enabled: true

  # Compactor for retention enforcement
  compactor:
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    delete_request_store: s3

singleBinary:
  replicas: 1
  persistence:
    enabled: false

# Disable other deployment modes
backend:
  replicas: 0
read:
  replicas: 0
write:
  replicas: 0

gateway:
  enabled: true
  replicas: 1
  service:
    type: ClusterIP

# Free-tier simplification: disable cache StatefulSets (they also caused ImageInspectError)
chunksCache:
  enabled: false
resultsCache:
  enabled: false

# Optional: disable canary to reduce pods (keep enabled if you like)
lokiCanary:
  enabled: false
