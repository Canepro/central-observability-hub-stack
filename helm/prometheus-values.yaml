# Prometheus Standalone Helm Chart Values
# Chart: prometheus-community/prometheus
# Version: 28.6.1+

# Use chart's default Kubernetes scrape configs (all enabled by default in v28)
# The chart provides well-maintained configs for:
# - prometheus (self-scrape)
# - kubernetes-apiservers
# - kubernetes-nodes
# - kubernetes-nodes-cadvisor
# - kubernetes-service-endpoints (+ slow)
# - kubernetes-services  
# - kubernetes-pods (+ slow)
# - prometheus-pushgateway

# Custom scrape jobs that aren't in chart defaults
extraScrapeConfigs: |
  # Custom scrape: kubelet PVC stats for OKE dashboarding
  - job_name: kubelet-volume-stats
    scheme: https
    kubernetes_sd_configs:
      - role: node
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics
    metric_relabel_configs:
      - source_labels: [__name__]
        action: keep
        regex: kubelet_volume_stats_(used_bytes|capacity_bytes|available_bytes|inodes|inodes_free)

serverFiles:
  alerting_rules.yml:
    groups:
      - name: WorldTreeAlerts
        rules:
          # 1. Spoke Heartbeat: Kind Cluster (Training)
          - alert: KindSpokeOffline
            expr: up{job="kind-kind-cluster"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Kind Spoke Offline"
              description: "The L4 proxy on port 6443 or the Lab Server is unreachable."

          # 2. Hub Infrastructure: OKE Storage
          - alert: OKEStorageWarning
            expr: (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) * 100 < 15
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Low Disk Space on OKE"
              description: "OKE Storage on {{ $labels.node }} is below 15% free space."

          # 3. GitOps Heartbeat: Argo CD Controller
          - alert: ArgoCDControllerDown
            expr: up{job="argocd-application-controller-metrics"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "ArgoCD Monitoring Down"
              description: "The ArgoCD application-controller is not reporting metrics."

          # 4. GitOps Health: Application Status
          - alert: ArgoCDApplicationDegraded
            expr: argocd_app_info{health_status="Degraded"} == 1
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "GitOps Application Degraded"
              description: "Application {{ $labels.name }} in project {{ $labels.project }} is in a failed state."

configmapReload:
  prometheus:
    enabled: true

server:
  retention: "15d"

  extraFlags:
    - web.enable-remote-write-receiver
    - web.enable-lifecycle

  persistentVolume:
    enabled: true
    size: 50Gi
    storageClass: oci-bv
    accessModes:
      - ReadWriteOnce

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2
      memory: 2Gi

  service:
    servicePort: 80
    type: ClusterIP

  # Global config - cluster label applied to ALL metrics via external_labels
  global:
    scrape_interval: 30s
    evaluation_interval: 30s
    external_labels:
      cluster: oke-hub
      environment: production
      workspace: hub
      domain: observability.canepro.me

# Alertmanager configuration
alertmanager:
  enabled: true
  persistence:
    enabled: false
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  extraEnvVars:
    - name: SMTP_PASSWORD
      valueFrom:
        secretKeyRef:
          name: grafana-smtp-credentials
          key: password
    - name: SMTP_USER
      valueFrom:
        secretKeyRef:
          name: grafana-smtp-credentials
          key: user
    - name: SMTP_FROM
      valueFrom:
        secretKeyRef:
          name: grafana-smtp-credentials
          key: from_address
    - name: SMTP_TO
      valueFrom:
        secretKeyRef:
          name: grafana-smtp-credentials
          key: to_address

  config:
    global:
      resolve_timeout: 5m
      smtp_from: '${SMTP_FROM}'
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_auth_username: '${SMTP_USER}'
      smtp_auth_password: '${SMTP_PASSWORD}'
      smtp_require_tls: true

    route:
      group_by: ['alertname', 'cluster', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'gmail-notifications'

    receivers:
      - name: 'gmail-notifications'
        email_configs:
          - to: '${SMTP_TO}'
            send_resolved: true

# Node Exporter for Infrastructure Metrics
nodeExporter:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# Kube State Metrics for Cluster Objects
kubeStateMetrics:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Pushgateway for ephemeral/batch jobs
pushgateway:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi
