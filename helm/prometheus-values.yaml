# Prometheus Standalone Helm Chart Values
# Chart: prometheus-community/prometheus
# Version: 27.47.0+

# --- ðŸš¨ CRITICAL: TOP LEVEL CONFIGURATION ðŸš¨ ---
# serverFiles must be at the top level, NOT nested under 'server:'
serverFiles:
  # Prometheus server config override (enables cluster label via scrape relabeling).
  # Goal: ensure ALL locally-scraped OKE series include `cluster="oke-hub"`,
  # so Grafana dashboards that filter on `cluster` include the hub as well as spokes.
  prometheus.yml: |
    global:
      evaluation_interval: 30s
      scrape_interval: 30s
      scrape_timeout: 10s

      # Note: external_labels are mainly for federation/remote_write identity.
      # Dashboard filtering relies on per-series labels; we set those via relabel_configs below.
      external_labels:
        cluster: oke-hub
        environment: production
        workspace: hub
        domain: observability.canepro.me

    rule_files:
      - /etc/config/recording_rules.yml
      - /etc/config/alerting_rules.yml
      - /etc/config/rules
      - /etc/config/alerts

    scrape_configs:
      - job_name: prometheus
        static_configs:
          - targets:
              - localhost:9090
        relabel_configs:
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub

      - job_name: kubernetes-apiservers
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - action: keep
            regex: default;kubernetes;https
            source_labels:
              - __meta_kubernetes_namespace
              - __meta_kubernetes_service_name
              - __meta_kubernetes_endpoint_port_name
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true

      - job_name: kubernetes-nodes
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - replacement: kubernetes.default.svc:443
            target_label: __address__
          - regex: (.+)
            replacement: /api/v1/nodes/$1/proxy/metrics
            source_labels:
              - __meta_kubernetes_node_name
            target_label: __metrics_path__
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true

      - job_name: kubernetes-nodes-cadvisor
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - replacement: kubernetes.default.svc:443
            target_label: __address__
          - regex: (.+)
            replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
            source_labels:
              - __meta_kubernetes_node_name
            target_label: __metrics_path__
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true

      - job_name: kubernetes-service-endpoints
        honor_labels: true
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - action: keep
            regex: true
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_scrape
          - action: drop
            regex: true
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow
          - action: replace
            regex: (https?)
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_scheme
            target_label: __scheme__
          - action: replace
            regex: (.+)
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_path
            target_label: __metrics_path__
          - action: replace
            regex: (.+?)(?::\\d+)?;(\\d+)
            replacement: $1:$2
            source_labels:
              - __address__
              - __meta_kubernetes_service_annotation_prometheus_io_port
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)
            replacement: __param_$1
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_service_name
            target_label: service
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_node_name
            target_label: node
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub

      - job_name: kubernetes-service-endpoints-slow
        honor_labels: true
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - action: keep
            regex: true
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow
          - action: replace
            regex: (https?)
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_scheme
            target_label: __scheme__
          - action: replace
            regex: (.+)
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_path
            target_label: __metrics_path__
          - action: replace
            regex: (.+?)(?::\\d+)?;(\\d+)
            replacement: $1:$2
            source_labels:
              - __address__
              - __meta_kubernetes_service_annotation_prometheus_io_port
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)
            replacement: __param_$1
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_service_name
            target_label: service
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_node_name
            target_label: node
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub
        scrape_interval: 5m
        scrape_timeout: 30s

      - job_name: prometheus-pushgateway
        honor_labels: true
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - action: keep
            regex: pushgateway
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_probe
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub

      - job_name: kubernetes-services
        honor_labels: true
        kubernetes_sd_configs:
          - role: service
        metrics_path: /probe
        params:
          module:
            - http_2xx
        relabel_configs:
          - action: keep
            regex: true
            source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_probe
          - source_labels:
              - __address__
            target_label: __param_target
          - replacement: blackbox
            target_label: __address__
          - source_labels:
              - __param_target
            target_label: instance
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - source_labels:
              - __meta_kubernetes_service_name
            target_label: service
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub

      - job_name: kubernetes-pods
        honor_labels: true
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: true
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scrape
          - action: drop
            regex: true
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow
          - action: replace
            regex: (https?)
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scheme
            target_label: __scheme__
          - action: replace
            regex: (.+)
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_path
            target_label: __metrics_path__
          - action: replace
            regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4})
            replacement: '[$2]:$1'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_port
              - __meta_kubernetes_pod_ip
            target_label: __address__
          - action: replace
            regex: (\\d+);((([0-9]+?)(\\.|$)){4})
            replacement: $2:$1
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_port
              - __meta_kubernetes_pod_ip
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)
            replacement: __param_$1
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: pod
          - action: drop
            regex: Pending|Succeeded|Failed|Completed
            source_labels:
              - __meta_kubernetes_pod_phase
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_node_name
            target_label: node
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub

      - job_name: kubernetes-pods-slow
        honor_labels: true
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: true
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow
          - action: replace
            regex: (https?)
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scheme
            target_label: __scheme__
          - action: replace
            regex: (.+)
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_path
            target_label: __metrics_path__
          - action: replace
            regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4})
            replacement: '[$2]:$1'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_port
              - __meta_kubernetes_pod_ip
            target_label: __address__
          - action: replace
            regex: (\\d+);((([0-9]+?)(\\.|$)){4})
            replacement: $2:$1
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_port
              - __meta_kubernetes_pod_ip
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)
            replacement: __param_$1
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: pod
          - action: drop
            regex: Pending|Succeeded|Failed|Completed
            source_labels:
              - __meta_kubernetes_pod_phase
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_node_name
            target_label: node
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub
        scrape_interval: 5m
        scrape_timeout: 30s

      # Custom scrape: kubelet PVC stats for OKE dashboarding
      - job_name: kubelet-volume-stats
        scheme: https
        kubernetes_sd_configs:
          - role: node
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics
          - source_labels: [cluster]
            regex: ""
            action: replace
            target_label: cluster
            replacement: oke-hub
        metric_relabel_configs:
          - source_labels: [__name__]
            action: keep
            regex: kubelet_volume_stats_(used_bytes|capacity_bytes|available_bytes|inodes|inodes_free)

    alerting:
      alertmanagers:
        - kubernetes_sd_configs:
            - role: pod
          tls_config:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          relabel_configs:
            - source_labels: [__meta_kubernetes_namespace]
              regex: monitoring
              action: keep
            - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_instance]
              regex: prometheus
              action: keep
            - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
              regex: alertmanager
              action: keep
            - source_labels: [__meta_kubernetes_pod_container_port_number]
              regex: "9093"
              action: keep

  alerting_rules.yml:
    groups:
      - name: WorldTreeAlerts
        rules:
          # 1. Spoke Heartbeat: Kind Cluster (Training)
          # Logic: If the 'up' metric for the Kind cluster job is 0 for 2m, the proxy or lab is down.
          - alert: KindSpokeOffline
            expr: up{job="kind-kind-cluster"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Kind Spoke Offline"
              description: "The L4 proxy on port 6443 or the Lab Server is unreachable."

          # 2. Hub Infrastructure: OKE Storage
          # Logic: Alert when PVCs or Node volumes have < 15% space remaining.
          - alert: OKEStorageWarning
            expr: (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) * 100 < 15
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Low Disk Space on OKE"
              description: "OKE Storage on {{ $labels.node }} is below 15% free space."

          # 3. GitOps Heartbeat: Argo CD Controller
          # Logic: Ensure the metrics service enabled via Terraform is being scraped.
          - alert: ArgoCDControllerDown
            expr: up{job="argocd-application-controller-metrics"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "ArgoCD Monitoring Down"
              description: "The ArgoCD application-controller is not reporting metrics."

          # 4. GitOps Health: Application Status
          # Logic: Alerts if any Argo CD application enters a 'Degraded' state (Sync failure, CrashLoop, etc).
          - alert: ArgoCDApplicationDegraded
            expr: argocd_app_info{health_status="Degraded"} == 1
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "GitOps Application Degraded"
              description: "Application {{ $labels.name }} in project {{ $labels.project }} is in a failed state."

configmapReload:
  prometheus:
    # sidecar to reload config when configmap changes
    extraArgs:
      listen-address: 0.0.0.0:8080

server:
  # Retention setting for historical metrics
  retention: "15d"

  # Lifecycle flags allow us to reload config via HTTP POST /-/reload
  extraFlags:
    - web.enable-remote-write-receiver
    - web.enable-lifecycle

  # Pod annotations to force restart when config changes
  # Update the timestamp to trigger a rolling restart via GitOps
  podAnnotations:
    config-reload-timestamp: "2026-01-18T19:09:00Z"

  # Storage configuration for OKE (Oracle Block Volume)
  persistentVolume:
    enabled: true
    size: 50Gi
    storageClass: oci-bv
    accessModes:
      - ReadWriteOnce

  # Resource limits for Hub cluster stability
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2
      memory: 2Gi

  # Service configuration
  service:
    servicePort: 80
    type: ClusterIP

  # Global Scrape Intervals and External Labels
  global:
    scrape_interval: 30s
    evaluation_interval: 30s
    # External labels: Added to all metrics scraped by this Prometheus server
    # This identifies metrics from the OKE Hub cluster itself
    external_labels:
      cluster: oke-hub
      environment: production
      workspace: hub
      domain: observability.canepro.me

# Alertmanager configuration for Multi-Cluster SMTP Notifications
alertmanager:
  enabled: true

  # Lab-friendly persistence and resource settings
  persistence:
    enabled: false
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Securely inject SMTP credentials from your K8s Secret
  extraEnvVars:
    - name: SMTP_PASSWORD
      valueFrom:
        secretKeyRef:
          name: grafana-smtp-credentials
          key: password
    - name: SMTP_USER
      valueFrom:
        secretKeyRef:
          name: grafana-smtp-credentials
          key: user
    - name: SMTP_FROM
      valueFrom:
        secretKeyRef:
          name: grafana-smtp-credentials
          key: from_address
    - name: SMTP_TO
      valueFrom:
        secretKeyRef:
          name: grafana-smtp-credentials
          key: to_address

  config:
    global:
      resolve_timeout: 5m
      # Variables injected via extraEnvVars
      smtp_from: '${SMTP_FROM}'
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_auth_username: '${SMTP_USER}'
      smtp_auth_password: '${SMTP_PASSWORD}'
      smtp_require_tls: true

    route:
      group_by: ['alertname', 'cluster', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'gmail-notifications'

    receivers:
    - name: 'gmail-notifications'
      email_configs:
      - to: '${SMTP_TO}'
        send_resolved: true # Send an email when the issue is cleared

# Node Exporter for Infrastructure Metrics
nodeExporter:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# Kube State Metrics for Cluster Objects
kubeStateMetrics:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Pushgateway for ephemeral/batch jobs
pushgateway:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi
