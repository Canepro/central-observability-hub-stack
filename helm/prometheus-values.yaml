# Prometheus Standalone Helm Chart Values
# Chart: prometheus-community/prometheus
# Version: 27.47.0+

# Add kubelet volume stats so Grafana can show live PVC usage (% full).
# This scrapes kubelet via the API server proxy and keeps ONLY volume stats metrics to avoid high cardinality.
extraScrapeConfigs: |
  - job_name: kubelet-volume-stats
    scheme: https
    kubernetes_sd_configs:
      - role: node
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics
    metric_relabel_configs:
      - source_labels: [__name__]
        action: keep
        regex: kubelet_volume_stats_(used_bytes|capacity_bytes|available_bytes|inodes|inodes_free)

configmapReload:
  prometheus:
    # Ensure the configmap-reloader sidecar exposes its health endpoint (the chart probes /healthz)
    extraArgs:
      listen-address: 0.0.0.0:8080

server:
  # Retention
  retention: "15d"

  # Enable Remote Write Receiver (CRITICAL for external metrics)
  extraFlags:
    - web.enable-remote-write-receiver
    - web.enable-lifecycle

  # Storage
  persistentVolume:
    enabled: true
    size: 50Gi
    storageClass: oci-bv
    accessModes:
      - ReadWriteOnce

  # Resource limits
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2
      memory: 2Gi

  # Service configuration
  service:
    servicePort: 80
    type: ClusterIP

  # Global Scrape Interval
  global:
    scrape_interval: 30s
    evaluation_interval: 30s

# Alertmanager
alertmanager:
  enabled: true
  persistence:
    enabled: false
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Node Exporter
nodeExporter:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# Kube State Metrics
kubeStateMetrics:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Pushgateway
pushgateway:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi
