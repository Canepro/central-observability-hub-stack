# Jenkins Controller on OKE (Phase 1 – Split-Agent Hybrid)
# Chart: jenkins/jenkins (https://charts.jenkins.io)
# Purpose: 24/7 controller on OKE; uses freed 50GB PVC (E1). AKS static agent connects via WebSocket (Phase 2).
#
# Version/plugins: Align with AKS Jenkins (ops repo jenkins-values.yaml). Image tag must exist on Docker Hub
# (e.g. 2.541.1-jdk17, lts-jdk17). Copy controller.installPlugins from AKS for exact parity.

# Release / naming
fullnameOverride: jenkins

# Controller
controller:
  componentName: jenkins-controller
  image:
    repository: jenkins/jenkins
    tag: "2.541.1-jdk17"
    pullPolicy: IfNotPresent

  numExecutors: 0
  executorMode: NORMAL

  # Admin: chart creates secret; change password after first login or set existingSecret
  admin:
    createSecret: true
    username: admin
    # password: set via existingSecret in production or change in UI after first login
    existingSecret: ""

  # Align with AKS: enough memory and -Xmx so startup does not OOM
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "4Gi"
  javaOpts: "-Xms1024m -Xmx3072m"

  # Probes: allow long startup after plugin updates (Jenkins can take 10–20 min to unpack/load)
  healthProbes: true
  probes:
    startupProbe:
      failureThreshold: 120  # 120 * 10s = 20 min (plugin updates need more time)
      periodSeconds: 10
      timeoutSeconds: 5
    livenessProbe:
      initialDelaySeconds: 300   # 5 min before first liveness check
      failureThreshold: 5
      periodSeconds: 10
      timeoutSeconds: 5
    readinessProbe:
      initialDelaySeconds: 300   # 5 min before first readiness check
      failureThreshold: 3
      periodSeconds: 10
      timeoutSeconds: 5

  serviceType: ClusterIP
  servicePort: 8080

  # Jenkins URL (required for agents and webhooks)
  jenkinsUrlProtocol: https
  jenkinsUrl: "https://jenkins-oke.canepro.me"

  # Ingress: expose on existing NGINX Ingress (jenkins-oke.canepro.me)
  ingress:
    enabled: true
    apiVersion: "networking.k8s.io/v1"
    ingressClassName: nginx
    hostName: jenkins-oke.canepro.me
    path: /
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    tls:
      - secretName: jenkins-oke-tls
        hosts:
          - jenkins-oke.canepro.me

  # Agent listener: WebSocket only (no JNLP 50000). AKS agent connects via -webSocket to HTTPS.
  agentListenerEnabled: true
  agentListenerPort: 50000
  agentListenerServiceType: ClusterIP
  disabledAgentProtocols:
    - JNLP-connect
    - JNLP2-connect

  # Plugins: align with AKS Jenkins for parity. kubernetes plugin required for agent { kubernetes { ... } } DSL.
  # eddsa-api required by trilead-api (git-client dependency)
  installPlugins:
    - configuration-as-code:latest
    - credentials-binding:latest
    - eddsa-api:latest
    - git:5.2.2
    - workflow-aggregator:596.v8c21c963d92d
    - kubernetes:latest
  installLatestPlugins: false
  overwritePluginsFromImage: true

  # JCasC: welcome message + static node for AKS agent. defaultConfig: false so chart does not inject kubernetes cloud (avoids ConfigurationAsCodeBootFailure).
  JCasC:
    defaultConfig: false
    overwriteConfiguration: false
    configScripts:
      welcome-message: |
        jenkins:
          systemMessage: "Jenkins on OKE (Split-Agent). AKS agent label: aks-agent. Connect with -webSocket over 443."
      aks-agent-node: |
        jenkins:
          nodes:
            - permanent:
                name: "aks-agent"
                numExecutors: 1
                remoteFS: "/home/jenkins/agent"
                labelString: "aks-agent"
                launcher:
                  inbound: {}
                retentionStrategy: "always"
      # Kubernetes cloud for dynamic agents on OKE (required for agent { kubernetes { ... } } DSL in Jenkinsfiles)
      oke-kubernetes-cloud: |
        jenkins:
          clouds:
            - kubernetes:
                name: "kubernetes"
                serverUrl: "https://kubernetes.default"
                namespace: "jenkins"
                jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"
                jenkinsTunnel: "jenkins-agent.jenkins.svc.cluster.local:50000"
                containerCapStr: "10"
                connectTimeout: "5"
                readTimeout: "15"
                maxRequestsPerHostStr: "32"
                retentionTimeout: "5"
                waitForPodSec: "600"

  # Sidecar: reload JCasC on config change
  sidecars:
    configAutoReload:
      enabled: true

  # Tests: disable to avoid extra resources
  testEnabled: false

# In-cluster K8s agent: enabled for dynamic pods on OKE (required for agent { kubernetes { ... } } DSL)
agent:
  enabled: true
  namespace: jenkins

# Persistence: use freed 50GB slot (E1); OCI Block Volume
persistence:
  enabled: true
  size: 50Gi
  storageClass: oci-bv
  accessMode: ReadWriteOnce
  existingClaim: ""

# RBAC
rbac:
  create: true
  readSecrets: false

serviceAccount:
  create: true
