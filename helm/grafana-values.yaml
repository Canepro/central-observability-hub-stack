# Grafana Helm Chart Values
# Chart: grafana/grafana
# Version: 7.3.0+
# App Version: 12.x

# ArgoCD/Helm render safeguard: allow admin password in values (prefer secret/env in production)
assertNoLeakedSecrets: false

# Deployment configuration
replicas: 1
deploymentStrategy:
  # RWO PVC + default RollingUpdate can deadlock during rollout if maxSurge > 0.
  # Use RollingUpdate with maxSurge=0 so the old pod is terminated before a new one is created.
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 0
    maxUnavailable: 1
image:
  repository: grafana/grafana
  tag: 11.1.0  # Pinning to a stable version to avoid 'uid' schema errors
  pullPolicy: IfNotPresent

# Persistence
persistence:
  enabled: true
  type: pvc
  storageClassName: oci-bv
  accessModes:
    - ReadWriteOnce
  size: 50Gi

# Service configuration
service:
  type: ClusterIP
  port: 80

# Resource limits for Always Free tier
resources:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    cpu: 1
    memory: 1Gi

# Health probe configuration to handle slow startup on free-tier nodes
readinessProbe:
  initialDelaySeconds: 60
  periodSeconds: 10
  failureThreshold: 5
livenessProbe:
  initialDelaySeconds: 120
  periodSeconds: 20
  failureThreshold: 3

# Grafana configuration
grafana.ini:
  server:
    root_url: https://grafana.canepro.me
  security:
    admin_user: admin
    admin_password: admin  # Change on first login
    secret_key: "observability-hub-secret-key" # Static key to prevent encryption/DB errors

# Datasource provisioning
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-server.monitoring.svc.cluster.local:80
        isDefault: true
        editable: true
      - name: Loki
        type: loki
        access: proxy
        url: http://loki-gateway.monitoring.svc.cluster.local
        editable: true
      - name: Tempo
        type: tempo
        access: proxy
        url: http://tempo.monitoring.svc.cluster.local:3200
        editable: true

# Dashboard provisioning
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

dashboards:
  default:
    master-health:
      json: |
        {
          "title": "Master Health Dashboard",
          "uid": "master-health",
          "tags": ["hub", "spoke", "health"],
          "timezone": "browser",
          "templating": {
            "list": [
              {
                "name": "cluster",
                "type": "query",
                "query": "label_values(up, cluster)",
                "refresh": 1,
                "includeAll": true,
                "allValue": ".*",
                "multi": false
              }
            ]
          },
          "panels": [
            {
              "title": "Heartbeat (Targets Up)",
              "type": "stat",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 0 },
              "targets": [
                { "expr": "sum(up)", "legendFormat": "Targets Up" }
              ]
            },
            {
              "title": "Guardrail (Node Root Disk Free %)",
              "type": "gauge",
              "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
              "targets": [
                { "expr": "min(100 * (node_filesystem_avail_bytes{mountpoint=\"/\", fstype!~\"tmpfs|overlay\"} / node_filesystem_size_bytes{mountpoint=\"/\", fstype!~\"tmpfs|overlay\"}))", "legendFormat": "Min Root Free %" }
              ],
              "fieldConfig": {
                "defaults": {
                  "unit": "percent",
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      { "color": "red", "value": null },
                      { "color": "yellow", "value": 10 },
                      { "color": "green", "value": 15 }
                    ]
                  }
                }
              }
            },
            {
              "title": "Immune System (Pods Running)",
              "type": "stat",
              "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
              "targets": [
                { "expr": "sum(kube_pod_status_phase{phase=\"Running\"})", "legendFormat": "Running Pods" }
              ]
            },
            {
              "title": "App Stack (Monitoring Pods Ready)",
              "type": "state-timeline",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 16 },
              "targets": [
                { "expr": "kube_pod_container_status_ready{namespace=~\"monitoring|argocd\"}", "legendFormat": "{{namespace}}/{{pod}}", "format": "time_series", "instant": false, "range": true }
              ]
            }
          ]
        }
