# Grafana Helm Chart Values
# Chart: grafana/grafana
# Version: 10.5.15 (pinned via ArgoCD Application)
# App Version: 12.x (Grafana OSS)

# ArgoCD/Helm render safeguard: prevent admin password/secret_key in values
assertNoLeakedSecrets: true

# Deployment configuration
replicas: 1
deploymentStrategy:
  # E1: no PVC (emptyDir); maxSurge=0 still safe for clean rollouts.
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 0
    maxUnavailable: 1

image:
  repository: grafana/grafana
  tag: 12.3.0  # Pin for controlled upgrades
  pullPolicy: IfNotPresent

# Persistence (E1: emptyDir to free 50GB for Jenkins on OKE; dashboards provisioned from git)
persistence:
  enabled: false
  # type: pvc  # was 50Gi; E1 frees this slot for Jenkins
  # storageClassName: oci-bv
  # accessModes: [ReadWriteOnce]
  # size: 50Gi

# Service configuration
service:
  type: ClusterIP
  port: 80

# Resource limits for Always Free tier
resources:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    cpu: 1
    memory: 1Gi

# Health probe configuration to handle slow startup on free-tier nodes
readinessProbe:
  initialDelaySeconds: 60
  periodSeconds: 10
  failureThreshold: 5
livenessProbe:
  initialDelaySeconds: 120
  periodSeconds: 20
  failureThreshold: 3

# Injecting SMTP Credentials via Environment Variables from Secret
# This keeps sensitive credentials (password, email) out of the public GitHub repo.
envValueFrom:
  GF_SECURITY_SECRET_KEY:
    secretKeyRef:
      name: grafana
      key: secret_key
  GF_SMTP_PASSWORD:
    secretKeyRef:
      name: grafana-smtp-credentials
      key: password
  GF_SMTP_USER:
    secretKeyRef:
      name: grafana-smtp-credentials
      key: user
  GF_SMTP_FROM_ADDRESS:
    secretKeyRef:
      name: grafana-smtp-credentials
      key: from_address

# Mount in-repo dashboards (dashboards/*.json) into the provisioning path.
# These are packaged by the `grafana-dashboards` ArgoCD app into:
# ConfigMap `grafana-dashboards-repo` (see dashboards/kustomization.yaml).
extraConfigmapMounts:
  - name: repo-dashboard-unified-world-tree
    configMap: grafana-dashboards-repo
    mountPath: /var/lib/grafana/dashboards/default/unified-world-tree.json
    subPath: unified-world-tree.json
    readOnly: true
  - name: repo-dashboard-master-health
    configMap: grafana-dashboards-repo
    mountPath: /var/lib/grafana/dashboards/default/master-health.json
    subPath: master-health-backup.json
    readOnly: true
  - name: repo-dashboard-aks-maintenance-jobs
    configMap: grafana-dashboards-repo
    mountPath: /var/lib/grafana/dashboards/default/aks-maintenance-jobs.json
    subPath: aks-maintenance-jobs.json
    readOnly: true

# Some upstream dashboards share the same UID, which breaks provisioning ("the
# same UID is used more than once") and disables DB writes for the provider.
# Patch the downloaded JSON on startup to ensure unique UIDs.
extraInitContainers:
  - name: fix-dashboard-uids
    image: busybox:1.36.1
    imagePullPolicy: IfNotPresent
    command: ["sh", "-c"]
    args:
      - |
        set -euf
        f="/var/lib/grafana/dashboards/default/loki-quick-search.json"
        if [ -f "$f" ]; then
          # Grafana.com dashboards 13186 and 12019 currently share uid=liz0yRCZz.
          sed -i 's/"uid": "liz0yRCZz"/"uid": "loki-quick-search"/' "$f" || true
        fi
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: RuntimeDefault
    volumeMounts:
      - name: storage
        mountPath: /var/lib/grafana

# Grafana configuration
grafana.ini:
  server:
    root_url: https://grafana.canepro.me
  security:
    admin_user: admin

  # SMTP Configuration
  # Credentials are automatically injected via environment variables above:
  # - GF_SMTP_PASSWORD: Password from secret
  # - GF_SMTP_USER: Email/username from secret
  # - GF_SMTP_FROM_ADDRESS: From address from secret
  smtp:
    enabled: true
    host: smtp.gmail.com:587
    # user and from_address are set via environment variables
    from_name: Grafana Alerts
    startTLS_policy: MandatoryStartTLS

# Datasource provisioning
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-server.monitoring.svc.cluster.local:80
        isDefault: true
        editable: true
      - name: Loki
        type: loki
        access: proxy
        url: http://loki-gateway.monitoring.svc.cluster.local
        editable: true
      - name: Tempo
        type: tempo
        access: proxy
        url: http://tempo.monitoring.svc.cluster.local:3200
        editable: true

# Dashboard provisioning
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Dashboards
# Custom dashboards live in `dashboards/*.json` and are mounted into the provider
# path by `extraConfigmapMounts` (see above). Public dashboards (gnet) are
# downloaded at startup into the same path.
dashboards:
  default:
    # Grafana.com dashboards (gnet). Pin revisions as needed.
    node-exporter-full:
      gnetId: 1860
      revision: latest
      datasource: Prometheus
    k8s-views-global:
      gnetId: 15757
      revision: latest
      datasource: Prometheus
    k8s-views-pods:
      gnetId: 15760
      revision: latest
      datasource: Prometheus
    k8s-dashboard-cn-20240513-starsl:
      gnetId: 13105
      revision: latest
      datasource: Prometheus
    rocketchat-metrics:
      gnetId: 23428
      revision: latest
      datasource: Prometheus
    rocketchat-microservices:
      gnetId: 23427
      revision: latest
      datasource: Prometheus
    rocketchat-mongodb-single-node:
      gnetId: 23712
      revision: latest
      datasource: Prometheus
    windows-exporter-starsl-20230531:
      gnetId: 10467
      revision: latest
      datasource: Prometheus
    loki-dashboard:
      gnetId: 13186
      revision: latest
      datasource: Loki
    loki-quick-search:
      gnetId: 12019
      revision: latest
      datasource: Loki
    opentelemetry-tempo:
      gnetId: 23242
      revision: latest
      datasource: Tempo
