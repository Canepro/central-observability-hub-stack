# Grafana Helm Chart Values
# Chart: grafana/grafana
# Version: 7.3.0+
# App Version: 12.x

# ArgoCD/Helm render safeguard: allow admin password in values (prefer secret/env in production)
assertNoLeakedSecrets: false

# Deployment configuration
replicas: 1
deploymentStrategy:
  # RWO PVC + default RollingUpdate can deadlock during rollout if maxSurge > 0.
  # Use RollingUpdate with maxSurge=0 so the old pod is terminated before a new one is created.
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 0
    maxUnavailable: 1
image:
  repository: grafana/grafana
  tag: 11.1.0  # Pinning to a stable version to avoid 'uid' schema errors
  pullPolicy: IfNotPresent

# Persistence
persistence:
  enabled: true
  type: pvc
  storageClassName: oci-bv
  accessModes:
    - ReadWriteOnce
  size: 50Gi

# Service configuration
service:
  type: ClusterIP
  port: 80

# Resource limits for Always Free tier
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 1
    memory: 1Gi

# Grafana configuration
grafana.ini:
  server:
    root_url: https://grafana.canepro.me
  security:
    admin_user: admin
    admin_password: admin  # Change on first login
    secret_key: "observability-hub-secret-key" # Static key to prevent encryption/DB errors

# Datasource provisioning
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-server.monitoring.svc.cluster.local:80
        isDefault: true
        editable: true
      - name: Loki
        type: loki
        access: proxy
        url: http://loki-gateway.monitoring.svc.cluster.local
        editable: true
      - name: Tempo
        type: tempo
        access: proxy
        url: http://tempo.monitoring.svc.cluster.local:3200
        editable: true

# Dashboard provisioning
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

dashboards:
  default:
    master-health:
      json: |
        {
          "title": "Master Health Dashboard",
          "uid": "master-health",
          "tags": ["hub", "spoke", "health"],
          "timezone": "browser",
          "templating": {
            "list": [
              {
                "name": "cluster",
                "type": "query",
                "query": "label_values(up, cluster)",
                "refresh": 1,
                "includeAll": true,
                "multi": false
              }
            ]
          },
          "panels": [
            {
              "title": "Heartbeat (Cluster Connectivity)",
              "type": "stat",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 0 },
              "targets": [
                { "expr": "up{cluster=\"oke-hub\"}", "legendFormat": "OKE Hub" },
                { "expr": "up{cluster=\"k3s-spoke\"}", "legendFormat": "K3s Spoke" },
                { "expr": "argocd_app_info{health_status=\"Healthy\"}", "legendFormat": "ArgoCD Health" }
              ],
              "fieldConfig": {
                "defaults": {
                  "mappings": [
                    { "type": "value", "options": { "1": { "text": "ONLINE", "color": "green" }, "0": { "text": "OFFLINE", "color": "red" } } }
                  ]
                }
              }
            },
            {
              "title": "Guardrail (Spoke Disk Usage %)",
              "type": "gauge",
              "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
              "targets": [
                { "expr": "(node_filesystem_avail_bytes{cluster=\"k3s-spoke\", mountpoint=\"/\"} / node_filesystem_size_bytes{cluster=\"k3s-spoke\", mountpoint=\"/\"}) * 100", "legendFormat": "Root Disk Free" }
              ],
              "fieldConfig": {
                "defaults": {
                  "unit": "percent",
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      { "color": "red", "value": null },
                      { "color": "yellow", "value": 10 },
                      { "color": "green", "value": 15 }
                    ]
                  }
                }
              }
            },
            {
              "title": "Immune System (Prune Job)",
              "type": "stat",
              "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
              "targets": [
                { "expr": "kube_cronjob_next_schedule_time{cronjob=\"k3s-image-prune\"}", "legendFormat": "Next Cleanup" }
              ],
              "fieldConfig": {
                "defaults": { "unit": "dateTimeFromNow" }
              }
            },
            {
              "title": "App Stack (RocketChat Microservices)",
              "type": "state-timeline",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 16 },
              "targets": [
                { "expr": "kube_pod_container_status_ready{namespace=\"rocketchat\", cluster=\"k3s-spoke\"}", "legendFormat": "{{pod}}" }
              ]
            }
          ]
        }
