# Grafana Helm Chart Values
# Chart: grafana/grafana
# Version: 10.5.15 (pinned via ArgoCD Application)
# App Version: 12.x (Grafana OSS)

# ArgoCD/Helm render safeguard: prevent admin password/secret_key in values
assertNoLeakedSecrets: true

# Deployment configuration
replicas: 1
annotations:
  # Work around occasional SSA/list-merge weirdness when changing volumeMount lists.
  # Replace makes ArgoCD recreate the Deployment instead of patching it.
  argocd.argoproj.io/sync-options: Replace=true
deploymentStrategy:
  # E1: no PVC (emptyDir); maxSurge=0 still safe for clean rollouts.
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 0
    maxUnavailable: 1

image:
  repository: grafana/grafana
  tag: 12.3.0  # Pin for controlled upgrades
  pullPolicy: IfNotPresent

# Persistence (E1: emptyDir to free 50GB for Jenkins on OKE; dashboards provisioned from git)
persistence:
  enabled: false
  # type: pvc  # was 50Gi; E1 frees this slot for Jenkins
  # storageClassName: oci-bv
  # accessModes: [ReadWriteOnce]
  # size: 50Gi

# Service configuration
service:
  type: ClusterIP
  port: 80

# Resource limits for Always Free tier
resources:
  requests:
    cpu: 50m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 768Mi

# Health probe configuration to handle slow startup on free-tier nodes
readinessProbe:
  initialDelaySeconds: 60
  periodSeconds: 10
  failureThreshold: 5
livenessProbe:
  initialDelaySeconds: 120
  periodSeconds: 20
  failureThreshold: 3

# Injecting SMTP Credentials via Environment Variables from Secret
# This keeps sensitive credentials (password, email) out of the public GitHub repo.
envValueFrom:
  GF_SECURITY_SECRET_KEY:
    secretKeyRef:
      name: grafana
      key: secret_key
  GF_SMTP_PASSWORD:
    secretKeyRef:
      name: grafana-smtp-credentials
      key: password
  GF_SMTP_USER:
    secretKeyRef:
      name: grafana-smtp-credentials
      key: user
  GF_SMTP_FROM_ADDRESS:
    secretKeyRef:
      name: grafana-smtp-credentials
      key: from_address

# Mount in-repo dashboards (dashboards/*.json) into the pod.
# These are packaged by the `grafana-dashboards` ArgoCD app into:
# ConfigMap `grafana-dashboards-repo` (see dashboards/kustomization.yaml).
#
# We mount the whole ConfigMap into a staging directory and then copy files into
# the provisioning directory in the `fix-dashboard-uids` initContainer. This is
# more robust than subPath-mounting individual files (which can occasionally end
# up as directories on some clusters/CSIs).
extraConfigmapMounts:
  - name: repo-dashboards
    configMap: grafana-dashboards-repo
    mountPath: /repo-dashboards
    subPath: ""
    readOnly: true

# Some upstream dashboards share the same UID, which breaks provisioning ("the
# same UID is used more than once") and disables DB writes for the provider.
# Patch the downloaded JSON on startup to ensure unique UIDs.
extraInitContainers:
  - name: fix-dashboard-uids
    image: busybox:1.36.1
    imagePullPolicy: IfNotPresent
    command: ["sh", "-c"]
    args:
      - |
        set -euf
        # Copy in-repo dashboards from the git-provisioned ConfigMap into Grafana's
        # provisioning directory. (The dashboards are mounted at /repo-dashboards.)
        d="/var/lib/grafana/dashboards/default"
        mkdir -p "$d"

        # Ensure any accidental dir mount points don't break provisioning.
        rm -rf "$d/aks-maintenance-jobs.json" "$d/master-health.json" "$d/unified-world-tree.json" "$d/rocketchat-mongodb-single-node.json" || true

        # Copy from the repo dashboard ConfigMap (git).
        cp -f /repo-dashboards/aks-maintenance-jobs.json "$d/aks-maintenance-jobs.json"
        cp -f /repo-dashboards/master-health-backup.json "$d/master-health.json"
        cp -f /repo-dashboards/unified-world-tree.json "$d/unified-world-tree.json"
        cp -f /repo-dashboards/rocketchat-mongodb-single-node.json "$d/rocketchat-mongodb-single-node.json"

        f="/var/lib/grafana/dashboards/default/loki-quick-search.json"
        if [ -f "$f" ]; then
          # Grafana.com dashboards 13186 and 12019 currently share uid=liz0yRCZz.
          sed -i 's/"uid": "liz0yRCZz"/"uid": "loki-quick-search"/' "$f" || true
        fi

        # Loki dashboards assume `instance` == pod, but our promtail labels use `pod`.
        # Patch the dashboards to match our label set.
        f="/var/lib/grafana/dashboards/default/loki-dashboard.json"
        if [ -f "$f" ]; then
          sed -i 's/instance=~\\\"$pod\\\"/pod=~\\\"$pod\\\"/g' "$f" || true

          # These dashboards ship with Prometheus templating queries but mark the datasource as Loki,
          # which makes Grafana send `label_values(...)` PromQL to Loki and results in:
          # "parse error at line 1, col 1: syntax error: unexpected IDENTIFIER".
          # Rewrite variables to use Loki label_values semantics.
          sed -i 's/label_values(kube_pod_info, namespace)/label_values(namespace)/g' "$f" || true
          sed -i 's/label_values(mixin_pod_workload{namespace=\\\"$namespace\\\"}, workload)/label_values({namespace=\\\"$namespace\\\"}, app)/g' "$f" || true
          sed -i 's/label_values(mixin_pod_workload{namespace=\\\"$namespace\\\", workload=\\\"$workload\\\"}, pod)/label_values({namespace=\\\"$namespace\\\", app=\\\"$workload\\\"}, pod)/g' "$f" || true
        fi
        f="/var/lib/grafana/dashboards/default/loki-quick-search.json"
        if [ -f "$f" ]; then
          sed -i 's/instance=~\\\"$pod\\\"/pod=~\\\"$pod\\\"/g' "$f" || true

          # Same issue as above: variable queries are Prometheus-flavored but datasource is Loki.
          sed -i 's/label_values(kube_pod_info, namespace)/label_values(namespace)/g' "$f" || true
          sed -i 's/label_values(container_network_receive_bytes_total{namespace=~\\\"$namespace\\\"},pod)/label_values({namespace=~\\\"$namespace\\\"}, pod)/g' "$f" || true
        fi

        # StarsL k8s dashboard (gnet 13105) ships with:
        # - a VictoriaMetrics-specific datasource UID placeholder
        # - `origin_prometheus=~"$origin_prometheus"` label matchers
        # Our stack is Prometheus-backed and doesn't have the `origin_prometheus` label.
        f="/var/lib/grafana/dashboards/default/k8s-dashboard-cn-20240513-starsl.json"
        if [ -f "$f" ]; then
          # BusyBox `sed -E` treats `\\{...\\}` as repetition, so do the UID replacement
          # with basic regex (unescaped `{}` are literals).
          sed -i 's/"uid": "${DS__VICTORIAMETRICS-PROD-ALL}"/"uid": "prometheus"/g' "$f" || true
          sed -E -i \
            -e 's/origin_prometheus=~\\\\\"\\$origin_prometheus\\\\\",//g' \
            -e 's/,origin_prometheus=~\\\\\"\\$origin_prometheus\\\\\"//g' \
            -e 's/origin_prometheus=~\\\\\"\\$origin_prometheus\\\\\"//g' \
            "$f" || true
        fi

        # Tempo gnet dashboard uses `${DS_PROMETHEUS}` placeholders (works via UI import prompts,
        # but not with file provisioning). Replace with our fixed Prometheus datasource uid.
        f="/var/lib/grafana/dashboards/default/opentelemetry-tempo.json"
        if [ -f "$f" ]; then
          sed -i 's/"uid": "${DS_PROMETHEUS}"/"uid": "prometheus"/g' "$f" || true
        fi
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: RuntimeDefault
    volumeMounts:
      - name: storage
        mountPath: /var/lib/grafana
      - name: repo-dashboards
        mountPath: /repo-dashboards

# Grafana configuration
grafana.ini:
  server:
    root_url: https://grafana.canepro.me
  security:
    admin_user: admin

  # SMTP Configuration
  # Credentials are automatically injected via environment variables above:
  # - GF_SMTP_PASSWORD: Password from secret
  # - GF_SMTP_USER: Email/username from secret
  # - GF_SMTP_FROM_ADDRESS: From address from secret
  smtp:
    enabled: true
    host: smtp.gmail.com:587
    # user and from_address are set via environment variables
    from_name: Grafana Alerts
    startTLS_policy: MandatoryStartTLS

# Datasource provisioning
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Prometheus
        uid: prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-server.monitoring.svc.cluster.local:80
        isDefault: true
        editable: true
      - name: Loki
        uid: loki
        type: loki
        access: proxy
        url: http://loki-gateway.monitoring.svc.cluster.local
        editable: true
      - name: Tempo
        uid: tempo
        type: tempo
        access: proxy
        url: http://tempo.monitoring.svc.cluster.local:3200
        editable: true

# Dashboard provisioning
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Dashboards
# Custom dashboards live in `dashboards/*.json` and are mounted into the provider
# path by `extraConfigmapMounts` (see above). Public dashboards (gnet) are
# downloaded at startup into the same path.
dashboards:
  default:
    # Grafana.com dashboards (gnet). Pin revisions as needed.
    node-exporter-full:
      gnetId: 1860
      revision: latest
      datasource: Prometheus
    argocd-dashboard:
      gnetId: 14584
      revision: latest
      datasource: Prometheus
    k8s-views-global:
      gnetId: 15757
      revision: latest
      datasource: Prometheus
    k8s-views-pods:
      gnetId: 15760
      revision: latest
      datasource: Prometheus
    k8s-dashboard-cn-20240513-starsl:
      gnetId: 13105
      revision: latest
      datasource: Prometheus
    rocketchat-metrics:
      gnetId: 23428
      revision: latest
      datasource: Prometheus
    rocketchat-microservices:
      gnetId: 23427
      revision: latest
      datasource: Prometheus
    windows-exporter-starsl-20230531:
      gnetId: 10467
      revision: latest
      datasource: Prometheus
    loki-dashboard:
      gnetId: 13186
      revision: latest
      datasource: Loki
    loki-quick-search:
      gnetId: 12019
      revision: latest
      datasource: Loki
    opentelemetry-tempo:
      gnetId: 23242
      revision: latest
      datasource: Tempo
